# STM32F446 智能小车项目

## 项目简介

这是一个基于STM32F446RET6微控制器的智能小车项目，集成了多种传感器和执行器，实现了自主导航、激光雷达扫描、姿态控制和通信功能。该项目采用STM32 HAL库开发，支持Keil MDK-ARM开发环境。

## 硬件配置

### 主控芯片
- **MCU**: STM32F446RET6 (LQFP64封装)
- **主频**: 84MHz (通过PLL配置)
- **Flash**: 512KB
- **RAM**: 128KB

### 外设配置
- **I2C1**: PB6(SCL), PB7(SDA) - 连接MPU6050陀螺仪
- **I2C3**: PA8(SCL), PC9(SDA) - 连接OLED显示屏
- **USART2**: PA2(TX), PA3(RX) - 调试串口
- **USART3**: PB10(TX), PC5(RX) - 通信串口
- **UART4**: PC10(TX), PC11(RX) - 激光雷达通信
- **TIM3**: PA6, PA7, PB0, PB1 - 电机PWM控制
- **TIM2**: PA0, PA1 - 左电机编码器
- **TIM8**: PC6, PC7 - 右电机编码器
- **TIM1**: 激光雷达任务定时器
- **TIM5**: 激光雷达数据发送定时器
- **TIM6**: 10ms系统定时器
- **TIM7**: 速度计算定时器

## 功能特性

### 1. 电机控制系统
- **双电机驱动**: 支持前进、后退、左转、右转、停止
- **PWM控制**: 使用TIM3产生4路PWM信号控制电机
- **编码器反馈**: TIM2和TIM8分别采集左右电机编码器信号
- **PID速度控制**: 实现精确的速度闭环控制

### 2. 姿态感知系统
- **MPU6050陀螺仪**: 通过I2C1接口连接
- **卡尔曼滤波**: 实现Roll、Pitch、Yaw角度融合
- **姿态控制**: 支持精确的角度转向控制

### 3. 激光雷达系统
- **AX激光雷达**: 通过UART4接口连接
- **360度扫描**: 支持520个扫描点
- **实时数据处理**: DMA方式接收激光雷达数据
- **数据上传**: 定时发送扫描数据到上位机

### 4. 通信系统
- **串口通信**: USART3实现与上位机通信
- **DMA传输**: 提高数据传输效率
- **协议解析**: 支持命令包解析和执行
- **数据上报**: 实时上报小车状态和传感器数据

### 5. 显示系统
- **OLED显示屏**: 通过I2C3接口连接
- **实时信息显示**: 显示角度、速度、状态等信息
- **多字体支持**: 支持8x16和6x8字体显示

## 软件架构

### 核心模块

#### 1. 主控制模块 (`main.c`)
- 系统初始化和配置
- 主循环控制
- 定时器中断处理
- 激光雷达数据发送

#### 2. 小车控制模块 (`car_control.c`)
- 电机控制函数
- PID角度控制
- 速度PID控制
- 运动控制算法

#### 3. 电机控制模块 (`motor.c`)
- 编码器数据采集
- 电机PID控制
- 角度控制算法

#### 4. 传感器模块 (`mpu6050.c`)
- MPU6050初始化和配置
- 加速度计和陀螺仪数据读取
- 卡尔曼滤波算法
- 姿态角计算

#### 5. 激光雷达模块 (`ax_laser.c`, `ax_laser_task.c`)
- 激光雷达初始化和控制
- 数据接收和解析
- 扫描数据处理

#### 6. 通信模块 (`communication.c`)
- 串口通信初始化
- 数据包解析
- DMA传输控制

#### 7. 显示模块 (`OLED.c`)
- OLED显示屏驱动
- 字符和数字显示
- 图形显示功能

### 数据结构

#### 命令包结构
```c
typedef struct {
    uint16_t data_len;    // 数据长度
    uint16_t cmd_id;      // 命令ID
    float turn_rad;       // 转向角度
    float distance;       // 前进距离
} CommandPacket_t;
```

#### 激光雷达数据结构
```c
typedef struct {
    uint8_t Quality;      // 数据质量
    uint16_t angle_q6;    // 角度(1/64度)
    uint16_t distance_q2; // 距离(1/4mm)
} RPLIDAR_Scan_Data_Send;
```

## 开发环境

### 必需软件
- **Keil MDK-ARM**: 5.x版本
- **STM32CubeMX**: 6.11.1版本
- **STM32F4 HAL库**: 最新版本

### 编译配置
- **编译器**: ARM Compiler v6
- **优化等级**: -O2
- **调试器**: ST-Link V2

## 使用方法

### 1. 硬件连接
1. 按照硬件配置连接各传感器和执行器
2. 确保电源供应稳定
3. 连接ST-Link调试器

### 2. 软件配置
1. 使用STM32CubeMX打开`test-pwm.ioc`文件
2. 根据需要调整外设配置
3. 生成代码并导入Keil项目

### 3. 编译下载
1. 打开Keil项目文件`test-pwm.uvprojx`
2. 编译项目
3. 下载到STM32F446芯片

### 4. 运行测试
1. 上电后OLED显示初始化信息
2. 激光雷达开始扫描
3. 通过串口发送控制命令

## 控制命令

### 基本运动命令
- `0x01`: 前进
- `0x02`: 后退  
- `0x03`: 停止
- `0x04`: 左转
- `0x05`: 右转

### 高级控制命令
通过USART3发送命令包，包含：
- 转向角度 (`turn_rad`)
- 前进距离 (`distance`)
- 命令ID (`cmd_id`)

## 数据通信协议

### 上行数据包
```c
struct {
    uint8_t Send_Begin_1;    // 包头1 (0x55)
    uint8_t Send_Begin_2;    // 包头2 (0xAA)
    uint32_t time_us;        // 时间戳
    uint16_t cmd_id;         // 命令ID
    uint8_t status;          // 状态
    int encoder_l;           // 左编码器
    int encoder_r;           // 右编码器
    float current_yaw;       // 当前偏航角
} packet;
```

### 激光雷达数据包
- 数据点数: 520个
- 每个点包含: 质量、角度、距离
- 传输方式: DMA批量传输

## 性能参数

- **扫描频率**: 10Hz
- **角度精度**: ±1度
- **距离精度**: ±4mm
- **控制频率**: 100Hz
- **通信波特率**: 115200bps

## 故障排除

### 常见问题
1. **MPU6050初始化失败**: 检查I2C连接和地址
2. **激光雷达无数据**: 检查UART4连接和波特率
3. **电机不转**: 检查PWM输出和电机驱动
4. **OLED无显示**: 检查I2C3连接和地址

### 调试方法
1. 使用USART2输出调试信息
2. OLED显示关键参数
3. LED指示系统状态
